#sub queries : A query written inside another present query 

SELECT first_name, last_name
FROM sakila.customer
WHERE address_id IN (
    SELECT address_id
    FROM sakila.customer
    WHERE customer_id = 1
);---It returns 1st customer first and last name

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------

SELECT actor_id, first_name, last_name
FROM sakila.actor
WHERE actor_id IN (
    SELECT actor_id
    FROM sakila.film_actor
    GROUP BY actor_id
    HAVING COUNT(film_id) > 10
); ----------it returns actor id , f name , l name of actor who have acted more than 10 films


---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#Sub query using  select 

SELECT actor_id,first_name,last_name,(
           SELECT COUNT(*)
           FROM sakila.film_actor
           WHERE film_actor.actor_id = actor.actor_id
       ) AS film_count
FROM sakila.actor;----------- It returns film count along with actor id, f name, l name 

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Derived Tables : It will not get saved in the database.temp table created inside a query using a subquery 

SELECT a.actor_id, a.first_name, a.last_name, fa.film_count
FROM sakila.actor a
JOIN (
    SELECT actor_id, COUNT(film_id) AS film_count
    FROM sakila.film_actor
    GROUP BY actor_id
    HAVING COUNT(film_id) > 10
) fa ON a.actor_id = fa.actor_id; ------ shows only film actors who acted more than 10 films 


SELECT customer_id, total_spent
FROM (
    SELECT customer_id, SUM(amount) AS total_spent
    FROM sakila.payment
    GROUP BY customer_id
    ORDER BY total_spent DESC
    LIMIT 5
) AS top_customers;----------------Top 5 payment in desc 


SELECT *
FROM (
    SELECT last_name,
           CASE 
               WHEN LEFT(last_name, 1) BETWEEN 'A' AND 'M' THEN 'Group A-M'
               WHEN LEFT(last_name, 1) BETWEEN 'N' AND 'Z' THEN 'Group N-Z'
               ELSE 'Other'
           END AS group_label
    FROM sakila.customer
) AS grouped_customers 
WHERE group_label = 'Group N-Z'; ------------------- It displays l name 1st letter 

# order of execution : FROM ---- > Where --->  select 

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Use subqueries when:
-- You need temporary results to build your main query
-- You are comparing against aggregate values

SELECT customer_id, amount
FROM sakila.payment
WHERE amount > (
    SELECT AVG(amount)
    FROM sakila.payment
);
#when sub query fail 

SELECT first_name,
       (SELECT address_id FROM sakila.address WHERE district = 'California'  ) AS cali_address
FROM sakila.customer;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#co related subqueries 
-- A correlated subquery is a subquery that:
-- Refers to a column from the outer (main) query
-- Is executed once for each row in the outer query
SELECT title,
  (SELECT COUNT(*)
   FROM sakila.film_actor fa
   WHERE fa.film_id = f.film_id) AS actor_count
FROM sakila.film f;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

SELECT payment_id, customer_id, amount, payment_date
FROM sakila.payment p1
WHERE amount > (
    SELECT AVG(amount)
    FROM sakila.payment p2
    WHERE p2.customer_id = p1.customer_id
);
select amount from sakila.customer;

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#Joins 
#INNER JOIN

SELECT f.title, l.name AS language
FROM sakila.film f
INNER JOIN sakila.language l ON f.language_id = l.language_id;

-- SELECT f.title, l.name AS language
-- FROM sakila.film f
-- INNER JOIN sakila.language l ON f.language_id = l.language_id;

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#LEFT JOIN

SELECT f.title, c.name AS category
FROM sakila.film f
LEFT JOIN sakila.film_category fc ON f.film_id = fc.film_id
LEFT JOIN sakila.category c ON fc.category_id = c.category_id;

SELECT c.customer_id, c.first_name, r.rental_id
FROM sakila.customer c
LEFT JOIN sakila.rental r ON c.customer_id = r.customer_id;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#fullouter join 
# List all actors and the films theyâ€™ve acted in (even if unmatched on either side

SELECT a.actor_id, a.first_name, fa.film_id
FROM sakila.actor a
LEFT JOIN sakila.film_actor fa ON a.actor_id = fa.actor_id

UNION

SELECT a.actor_id, a.first_name, fa.film_id
FROM sakila.actor a
RIGHT JOIN sakila.film_actor fa ON a.actor_id = fa.actor_id;
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#  List all customers and all rentals, including those without each other

SELECT c.customer_id, r.rental_id
FROM sakila.customer c
LEFT JOIN sakila.rental r ON c.customer_id = r.customer_id

UNION

SELECT c.customer_id, r.rental_id
FROM sakila.customer c
RIGHT JOIN sakila.rental r ON c.customer_id = r.customer_id;

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

#SELF JOIN

SELECT s1.staff_id, s2.staff_id, s1.store_id
FROM sakila.staff s1
JOIN sakila.staff s2 ON s1.store_id = s2.store_id
WHERE s1.staff_id <> s2.staff_id;

Ex:
-- 1. Create the staff_demo table
CREATE TABLE sakila.staff_demo (
    staff_id INT PRIMARY KEY,
    first_name VARCHAR(50),
    store_id INT
);

-- 2. Insert sample data
INSERT INTO sakila.staff_demo (staff_id, first_name, store_id) VALUES
(1, 'Alice', 1),
(2, 'Bob', 1),
(3, 'Charlie', 2),
(4, 'Diana', 2),
(5, 'Ethan', 1);

-- 3. Run a self join: find staff pairs working in the same store
SELECT 
    s1.staff_id AS staff_1_id,
    s1.first_name AS staff_1_name,
    s2.staff_id AS staff_2_id,
    s2.first_name AS staff_2_name,
    s1.store_id
FROM sakila.staff_demo s1
JOIN sakila.staff_demo s2
  ON s1.store_id = s2.store_id
  AND s1.staff_id <> s2.staff_id
ORDER BY s1.store_id, s1.staff_id;

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#where exists / insersect/ inner join 

SELECT DISTINCT p.customer_id,p.rental_id
FROM sakila.payment p
WHERE EXISTS (
    SELECT 1
    FROM sakila.rental r
    WHERE r.customer_id = p.customer_id
);

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

SELECT s.email FROM sakila.customer c
LEFT JOIN sakila.staff s ON 1 = 0

UNION
SELECT s.email FROM sakila.staff s
LEFT JOIN sakila.customer c ON 1 = 0;
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Cardinality:
1:1
1:Many
Many:1
Many:Many
